<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DinoPepe: Super Edition ü¶ñ</title>

<link rel="manifest" href="manifest.json">

<meta name="theme-color" content="#4caf50">

<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DinoPepe">

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: #87ceeb;
    font-family: 'Courier New', monospace;
    overflow: hidden;
    text-align: center;
    touch-action: none;
    transition: background 2s ease;
    user-select: none;
    -webkit-user-select: none;
}

canvas {
    display: block;
    margin: 0 auto;
    cursor: pointer;
}

#ui {
    position: fixed;
    top: 8px;
    width: 100%;
    z-index: 10;
    font-size: 13px;
    color: #333;
    text-shadow: 1px 1px 2px white;
    pointer-events: none; /* Deixa clicar no jogo atrav√©s da UI */
}

/* Reativar pointer events para bot√µes espec√≠ficos na UI */
#ui input, #ui button, #ui label {
    pointer-events: auto;
}

#pauseBtn {
    position: fixed;
    top: 10px;
    right: 10px;
    font-size: 2rem;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    background: rgba(76, 175, 80, 0.9);
    color: white;
    cursor: pointer;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    display: none;
}

#pauseBtn:active {
    transform: scale(0.95);
}

#shopBtn {
    position: fixed;
    top: 70px;
    right: 10px;
    font-size: 1.5rem;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 152, 0, 0.9);
    color: white;
    cursor: pointer;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    display: none; /* Aparece s√≥ quando pausado ou game over, ou sempre, controlaremos via JS */
}

#powerupBar {
    margin-top: 6px;
    font-size: 12px;
}

.active-powerup {
    background: rgba(76, 175, 80, 0.3);
    padding: 2px 8px;
    border-radius: 4px;
    display: inline-block;
    margin: 0 4px;
}

#upload {
    margin-top: 8px;
    pointer-events: auto;
}

#upload input {
    font-size: 12px;
    padding: 4px 8px;
}

#photoPreview {
    display: none;
    margin-top: 8px;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

#photoPreview img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid #4caf50;
}

#removePhoto {
    padding: 4px 8px;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
}

#gameOverScreen, #tutorialScreen, #shopScreen {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    z-index: 999;
}

#tutorialScreen {
    display: flex;
}

#tutorialScreen h2, #shopScreen h2 {
    margin-bottom: 20px;
    font-size: 2rem;
}

#tutorialScreen p {
    font-size: 1.2rem;
    margin: 10px 0;
}

.btn {
    font-size: 1.5rem;
    padding: 12px 32px;
    margin: 10px;
    border-radius: 12px;
    border: none;
    background: #4caf50;
    color: white;
    cursor: pointer;
    transition: transform 0.1s;
}

.btn:active {
    transform: scale(0.95);
}

#gameOverScreen h1 {
    font-size: 2.5rem;
    margin-bottom: 20px;
}

#finalScore {
    font-size: 1.8rem;
    margin: 10px 0;
}

/* Estilos da Loja */
#shopItems {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 600px;
    padding: 20px;
}

.shop-item {
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 12px;
    padding: 15px;
    width: 100px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: rgba(0,0,0,0.5);
}

.shop-item:active {
    transform: scale(0.95);
}

.shop-item.owned {
    border-color: #4caf50;
}

.shop-item.selected {
    background: rgba(76, 175, 80, 0.4);
    border-color: #8bc34a;
    box-shadow: 0 0 10px #8bc34a;
}
</style>
</head>

<body>

<div id="tutorialScreen">
    <div>
        <h2>ü¶ñ DinoPepe</h2>
        <p>üéÆ Como jogar:</p>
        <p>üì± <strong>Celular:</strong> Balance para cima ou toque na tela</p>
        <p>üíª <strong>PC:</strong> Pressione ESPA√áO ou clique</p>
        <p>ü™ô Colete moedas para comprar chap√©us!</p>
        <p>‚ö° Pegue Power-ups: Escudo, √çm√£, Dash!</p>
        <p><br>Envie uma foto para usar como rosto do dino!</p>
        <button class="btn" id="startBtn">Come√ßar</button>
    </div>
</div>

<div id="shopScreen">
    <h2>üè™ Loja do Dino</h2>
    <p>Suas Moedas: <strong id="shopCoinsDisplay" style="color: gold;">0</strong></p>
    <div id="shopItems"></div>
    <button class="btn" id="closeShopBtn" style="background:#f44336; margin-top:20px;">Fechar</button>
</div>

<div id="ui">
    <div style="font-size: 16px; font-weight: bold;">ü¶ñ DinoPepe</div>
    <div id="scoreText"></div>
    <div id="powerupBar"></div>
    <div id="upload">
        <input type="file" id="faceUpload" accept="image/*">
        <div id="photoPreview">
            <img id="previewImg" src="" alt="Preview">
            <button id="removePhoto">Remover</button>
        </div>
    </div>
</div>

<canvas id="game"></canvas>

<button id="pauseBtn">‚è∏Ô∏è</button>
<button id="shopBtn">üõí</button>

<div id="gameOverScreen">
    <h1>Game Over! üò¢</h1>
    <div id="finalScore"></div>
    <button class="btn" id="restartBtn">Jogar Novamente</button>
    <button class="btn" id="openShopFromOver" style="background:#ff9800">Ir para Loja üõí</button>
</div>

<script>
/* ================= CONFIG ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = Math.min(400, window.innerHeight * 0.6);
}
resize();
window.addEventListener("resize", resize);

const GRAVITY = 0.65;
const JUMP_FORCE = -13.5;
const MAX_PARTICLES = 50;
const MAX_COINS = 30;
const MAX_POWERUPS = 5;
let gameSpeed = 5;
let baseGameSpeed = 5;
let gameStarted = false;
let gamePaused = false;

/* ================= SONS ================= */
function createBeep(freq, duration, type = 'sine') {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    return () => {
        try {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.frequency.value = freq;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + duration);
        } catch(e) {}
    };
}

const jumpSound = createBeep(800, 0.1, 'square');
const hitSound = createBeep(200, 0.3, 'sawtooth');
const coinSound = createBeep(1200, 0.05, 'sine');
const powerupSound = createBeep(1500, 0.15, 'triangle');
const dashSound = createBeep(600, 0.3, 'square');

/* ================= LOJA E ESTADO (PERSIST√äNCIA) ================= */
// Carregar dados salvos ou iniciar com padr√£o
let savedTotalCoins = Number(localStorage.getItem("dinopepe_coins")) || 0;
let currentHat = localStorage.getItem("dinopepe_hat") || 'none';
let ownedHats = JSON.parse(localStorage.getItem("dinopepe_owned_hats")) || ['none'];

// Atualiza a vari√°vel global do jogo para usar no placar
let totalCoins = savedTotalCoins; 

const shopItems = [
    { id: 'none', icon: '‚ùå', name: 'Nada', price: 0 },
    { id: 'party', icon: 'üéâ', name: 'Festa', price: 50 },
    { id: 'crown', icon: 'üëë', name: 'Rei', price: 100 },
    { id: 'cowboy', icon: 'ü§†', name: 'Sheriff', price: 150 },
    { id: 'astro', icon: 'üßë‚ÄçüöÄ', name: 'Astro', price: 300 },
    { id: 'ninja', icon: 'ü•∑', name: 'Ninja', price: 500 }
];

function saveGameData() {
    localStorage.setItem("dinopepe_coins", totalCoins);
    localStorage.setItem("dinopepe_hat", currentHat);
    localStorage.setItem("dinopepe_owned_hats", JSON.stringify(ownedHats));
    localStorage.setItem("dinopepe_recorde", bestScore);
}

function renderShop() {
    const container = document.getElementById('shopItems');
    const coinsDisplay = document.getElementById('shopCoinsDisplay');
    container.innerHTML = '';
    coinsDisplay.textContent = totalCoins;

    shopItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'shop-item';
        const isOwned = ownedHats.includes(item.id);
        const isSelected = currentHat === item.id;

        if (isOwned) div.classList.add('owned');
        if (isSelected) div.classList.add('selected');

        div.innerHTML = `
            <div style="font-size: 30px; margin-bottom: 5px;">${item.icon}</div>
            <div style="font-size: 12px; margin-bottom: 5px;">${item.name}</div>
            <div style="font-size: 14px; color: ${isOwned ? '#8bc34a' : 'gold'}; font-weight: bold;">
                ${isOwned ? 'OK' : item.price + ' ü™ô'}
            </div>
        `;

        div.onclick = () => {
            if (isOwned) {
                currentHat = item.id;
                saveGameData();
                renderShop();
            } else {
                if (totalCoins >= item.price) {
                    if(confirm(`Comprar ${item.name} por ${item.price} moedas?`)) {
                        totalCoins -= item.price;
                        ownedHats.push(item.id);
                        currentHat = item.id;
                        saveGameData();
                        renderShop();
                    }
                } else {
                    alert("Moedas insuficientes! Jogue mais para ganhar.");
                }
            }
        };

        container.appendChild(div);
    });
}

// Bot√µes da Loja
const shopScreen = document.getElementById('shopScreen');
const shopBtn = document.getElementById('shopBtn');

shopBtn.onclick = () => {
    // Pausa se estiver jogando
    if(gameStarted && !gameOver) {
        gamePaused = true;
        document.getElementById('pauseBtn').textContent = "‚ñ∂Ô∏è";
    }
    renderShop();
    shopScreen.style.display = 'flex';
};

document.getElementById('closeShopBtn').onclick = () => {
    shopScreen.style.display = 'none';
};

document.getElementById('openShopFromOver').onclick = () => {
    renderShop();
    shopScreen.style.display = 'flex';
};

/* ================= TEMAS DIN√ÇMICOS ================= */
function getCurrentTheme(score) {
    if (score < 500) {
        return {
            skyTop: '#87ceeb',
            skyBottom: '#b8e6f5',
            groundColor: '#9be27d',
            cloudOpacity: 0.7,
            stars: false,
            moon: false,
            mountainColor: 'rgba(100, 140, 80, 0.4)'
        };
    } else if (score < 1500) {
        return {
            skyTop: '#ff9a56',
            skyBottom: '#ffd89b',
            groundColor: '#8ab85f',
            cloudOpacity: 0.5,
            stars: false,
            moon: false,
            mountainColor: 'rgba(120, 100, 70, 0.4)'
        };
    } else if (score < 3000) {
        return {
            skyTop: '#5f3b7a',
            skyBottom: '#c76ca6',
            groundColor: '#6b9151',
            cloudOpacity: 0.3,
            stars: true,
            moon: false,
            mountainColor: 'rgba(80, 60, 100, 0.5)'
        };
    } else {
        return {
            skyTop: '#1a1a2e',
            skyBottom: '#16213e',
            groundColor: '#4a6741',
            cloudOpacity: 0.2,
            stars: true,
            moon: true,
            mountainColor: 'rgba(40, 40, 60, 0.6)'
        };
    }
}

let currentTheme = getCurrentTheme(0);
let stars = [];

/* ================= POWER-UPS ================= */
let activePowerups = {
    shield: 0,
    magnet: 0,
    slowmo: 0,
    dash: 0
};

let powerups = [];
let powerupTimer = 0;

function createPowerup() {
    if (powerups.length >= MAX_POWERUPS) return;
    
    // Adicionado 'dash' na lista
    const types = ['shield', 'magnet', 'slowmo', 'dash'];
    const type = types[Math.floor(Math.random() * types.length)];
    
    powerups.push({
        x: canvas.width + 30,
        y: groundY - 80 - Math.random() * 60,
        w: 30,
        h: 30,
        type: type,
        float: 0
    });
}

function updatePowerups() {
    if (!gameStarted || gamePaused) return;
    
    powerupTimer++;
    if (powerupTimer > 600 && Math.random() < 0.01) {
        createPowerup();
        powerupTimer = 0;
    }
    
    powerups.forEach(p => {
        p.x -= gameSpeed;
        p.float += 0.1;
        
        if (activePowerups.magnet > 0) {
            const dx = dino.x - p.x;
            const dy = dino.y - p.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 150) {
                p.x += dx * 0.08;
                p.y += dy * 0.08;
            }
        }
        
        if (
            dino.x < p.x + p.w &&
            dino.x + dino.w > p.x &&
            dino.y < p.y + p.h &&
            dino.y + dino.h > p.y
        ) {
            activePowerups[p.type] = 300; // 5 segundos (a 60fps)
            powerupSound();
            createParticles(p.x + p.w/2, p.y + p.h/2, '#ffd700');
            createFloatingText(dino.x, dino.y - 20, p.type.toUpperCase() + "!", "#fff");
            p.collected = true;

            if(p.type === 'dash') {
                dashSound();
            }
        }
    });
    
    powerups = powerups.filter(p => !p.collected && p.x + p.w > 0);
    
    Object.keys(activePowerups).forEach(key => {
        if (activePowerups[key] > 0) activePowerups[key]--;
    });
    
    // L√≥gica de Velocidade com PowerUps
    if (activePowerups.dash > 0) {
        gameSpeed = 15; // Velocidade insana
    } else if (activePowerups.slowmo > 0) {
        gameSpeed = baseGameSpeed * 0.5;
    } else {
        gameSpeed = baseGameSpeed;
    }
}

function drawPowerups() {
    powerups.forEach(p => {
        const y = p.y + Math.sin(p.float) * 5;
        
        ctx.save();
        ctx.shadowBlur = 15;
        ctx.shadowColor = 'rgba(255, 215, 0, 0.6)';
        
        if (p.type === 'shield') {
            ctx.strokeStyle = '#2196F3';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(p.x + p.w/2, y + p.h/2, 12, 0, Math.PI * 2);
            ctx.stroke();
            ctx.fillStyle = '#64B5F6';
            ctx.font = '20px Arial';
            ctx.fillText('üõ°Ô∏è', p.x + 5, y + 22);
        } else if (p.type === 'magnet') {
            ctx.fillStyle = '#E91E63';
            ctx.fillRect(p.x + 5, y + 5, 8, 20);
            ctx.fillRect(p.x + 17, y + 5, 8, 20);
            ctx.fillStyle = '#C2185B';
            ctx.fillRect(p.x + 5, y + 20, 20, 5);
        } else if (p.type === 'slowmo') {
            ctx.strokeStyle = '#FF9800';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(p.x + p.w/2, y + p.h/2, 12, 0, Math.PI * 2);
            ctx.stroke();
            ctx.fillStyle = '#FFA726';
            ctx.fillText('‚è±Ô∏è', p.x + 5, y + 22);
        } else if (p.type === 'dash') {
            ctx.strokeStyle = '#FFFF00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(p.x + p.w/2, y + p.h/2, 14, 0, Math.PI * 2);
            ctx.stroke();
            ctx.fillStyle = '#FFFF00';
            ctx.font = '20px Arial';
            ctx.fillText('‚ö°', p.x + 5, y + 22);
        }
        
        ctx.restore();
    });
}

function drawPowerupBar() {
    let html = '';
    if (activePowerups.shield > 0) {
        html += `<span class="active-powerup">üõ°Ô∏è ${Math.ceil(activePowerups.shield/60)}s</span>`;
    }
    if (activePowerups.magnet > 0) {
        html += `<span class="active-powerup">üß≤ ${Math.ceil(activePowerups.magnet/60)}s</span>`;
    }
    if (activePowerups.slowmo > 0) {
        html += `<span class="active-powerup">‚è±Ô∏è ${Math.ceil(activePowerups.slowmo/60)}s</span>`;
    }
    if (activePowerups.dash > 0) {
        html += `<span class="active-powerup" style="background:rgba(255,255,0,0.4)">‚ö° ${Math.ceil(activePowerups.dash/60)}s</span>`;
    }
    document.getElementById('powerupBar').innerHTML = html;
}

/* ================= TEXTO FLUTUANTE ================= */
let floatingTexts = [];

function createFloatingText(x, y, text, color) {
    floatingTexts.push({
        x: x,
        y: y,
        text: text,
        color: color,
        life: 40,
        dy: -1.5
    });
}

function updateDrawFloatingTexts() {
    ctx.font = "bold 16px Arial";
    floatingTexts = floatingTexts.filter(t => t.life > 0);
    
    floatingTexts.forEach(t => {
        t.y += t.dy;
        t.life--;
        ctx.fillStyle = t.color;
        ctx.globalAlpha = t.life / 40;
        ctx.fillText(t.text, t.x, t.y);
        ctx.globalAlpha = 1;
    });
}

/* ================= MOEDAS ================= */
let coins = [];
let coinTimer = 0;

function createCoin() {
    if (coins.length >= MAX_COINS) return;
    
    const pattern = Math.random();
    
    if (pattern < 0.5) {
        coins.push({
            x: canvas.width + 30,
            y: groundY - 60 - Math.random() * 80,
            w: 20,
            h: 20,
            spin: 0
        });
    } else {
        const startY = groundY - 100;
        for (let i = 0; i < 5; i++) {
            coins.push({
                x: canvas.width + 30 + i * 40,
                y: startY,
                w: 20,
                h: 20,
                spin: 0
            });
        }
    }
}

function updateCoins() {
    if (!gameStarted || gamePaused) return;
    
    coinTimer++;
    if (coinTimer > 120) {
        createCoin();
        coinTimer = 0;
    }
    
    coins.forEach(c => {
        c.x -= gameSpeed;
        c.spin += 0.15;
        
        if (activePowerups.magnet > 0) {
            const dx = dino.x - c.x;
            const dy = dino.y - c.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 150) {
                c.x += dx * 0.1;
                c.y += dy * 0.1;
            }
        }
        
        if (
            dino.x < c.x + c.w &&
            dino.x + dino.w > c.x &&
            dino.y < c.y + c.h &&
            dino.y + dino.h > c.y
        ) {
            totalCoins++;
            score += 5;
            coinSound();
            createParticles(c.x + c.w/2, c.y + c.h/2, '#FFD700');
            createFloatingText(c.x, c.y, "+5", "#FFD700"); // Efeito visual de texto
            c.collected = true;
            saveGameData(); // Salva as moedas
        }
    });
    
    coins = coins.filter(c => !c.collected && c.x + c.w > 0);
}

function drawCoins() {
    coins.forEach(c => {
        const scale = Math.abs(Math.cos(c.spin));
        
        ctx.save();
        ctx.translate(c.x + c.w/2, c.y + c.h/2);
        ctx.scale(scale, 1);
        
        ctx.fillStyle = '#FFD700';
        ctx.strokeStyle = '#FFA500';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(0, 0, 10, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();
        
        ctx.fillStyle = '#FFA500';
        ctx.font = 'bold 12px Arial';
        ctx.fillText('$', -4, 4);
        
        ctx.restore();
    });
}

/* ================= DINO ================= */
let faceImage = null;
let animFrame = 0;

const dino = {
    x: 80,
    y: 0,
    w: 44,
    h: 50,
    vy: 0,
    jumping: false,
    doubleJumped: false, // Controle de pulo duplo
    legFrame: 0,

    jump() {
        if (!gameStarted || gameOver || gamePaused) return;

        // Pulo Normal
        if (!this.jumping) {
            this.vy = JUMP_FORCE;
            this.jumping = true;
            this.doubleJumped = false; // Reseta pulo duplo
            jumpSound();
            createParticles(this.x + this.w/2, this.y + this.h, '#9be27d');
        } 
        // Pulo Duplo
        else if (!this.doubleJumped) {
            this.vy = JUMP_FORCE * 0.85; // Um pouco mais fraco
            this.doubleJumped = true;
            jumpSound();
            createParticles(this.x + this.w/2, this.y + this.h, '#ffffff'); // Part√≠culas brancas
        }
    },

    update() {
        this.vy += GRAVITY;
        this.y += this.vy;

        if (this.y >= groundY - this.h) {
            this.y = groundY - this.h;
            this.vy = 0;
            this.jumping = false;
            this.doubleJumped = false; // Reseta ao tocar o ch√£o
            if (gameStarted) this.legFrame = (this.legFrame + 0.2) % 2;
        }
    },

    draw() {
        ctx.save();
        
        // Efeito do Escudo
        if (activePowerups.shield > 0) {
            ctx.strokeStyle = '#2196F3';
            ctx.lineWidth = 3;
            ctx.globalAlpha = 0.5 + Math.sin(animFrame * 0.2) * 0.3;
            ctx.beginPath();
            ctx.arc(this.x + this.w/2, this.y + this.h/2, 35, 0, Math.PI * 2);
            ctx.stroke();
            ctx.globalAlpha = 1;
        }

        // Efeito Dash (Rastro)
        if (activePowerups.dash > 0) {
            ctx.globalAlpha = 0.4;
            ctx.fillStyle = '#FFFF00';
            ctx.beginPath();
            ctx.ellipse(this.x - 10, this.y + 25, 20, 20, 0, 0, Math.PI*2);
            ctx.fill();
            ctx.globalAlpha = 1;
        }
        
        const bodyGradient = ctx.createLinearGradient(this.x, this.y, this.x, this.y + this.h);
        bodyGradient.addColorStop(0, '#4a9d4e');
        bodyGradient.addColorStop(1, '#2d5f30');
        ctx.fillStyle = bodyGradient;
        
        // Corpo
        ctx.beginPath();
        ctx.ellipse(this.x + 22, this.y + 35, 18, 20, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Pesco√ßo
        ctx.fillRect(this.x + 18, this.y + 15, 12, 22);
        
        // Cabe√ßa
        ctx.beginPath();
        ctx.ellipse(this.x + this.w / 2, this.y + 15, 16, 16, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Crista
        ctx.fillStyle = '#ff6b6b';
        ctx.beginPath();
        ctx.moveTo(this.x + 16, this.y + 8);
        ctx.lineTo(this.x + 20, this.y);
        ctx.lineTo(this.x + 24, this.y + 6);
        ctx.lineTo(this.x + 28, this.y + 2);
        ctx.lineTo(this.x + 32, this.y + 8);
        ctx.fill();
        
        // Rosto (Imagem ou Desenho)
        if (faceImage) {
            ctx.save();
            ctx.beginPath();
            ctx.arc(this.x + this.w / 2, this.y + 15, 12, 0, Math.PI * 2);
            ctx.clip();
            ctx.drawImage(faceImage, this.x + 12, this.y + 3, 24, 24);
            ctx.restore();
        } else {
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(this.x + 28, this.y + 12, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(this.x + 29, this.y + 12, 2, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Desenhar Chap√©u Selecionado
        ctx.font = "24px Arial";
        const hatX = this.x + 8;
        const hatY = this.y - 2;
        if (currentHat === 'party') ctx.fillText('üéâ', hatX, hatY);
        else if (currentHat === 'crown') ctx.fillText('üëë', hatX, hatY);
        else if (currentHat === 'cowboy') ctx.fillText('ü§†', hatX, hatY);
        else if (currentHat === 'astro') ctx.fillText('üßë‚ÄçüöÄ', hatX, hatY);
        else if (currentHat === 'ninja') ctx.fillText('ü•∑', hatX, hatY);

        // Bra√ßos
        ctx.fillStyle = '#4a9d4e';
        ctx.fillRect(this.x + 8, this.y + 28, 6, 12);
        ctx.fillRect(this.x + 30, this.y + 28, 6, 12);
        
        // Pernas (Anima√ß√£o)
        const legOffset = this.jumping ? 0 : Math.floor(this.legFrame) * 4;
        ctx.fillRect(this.x + 14, this.y + 50, 8, 15);
        ctx.fillRect(this.x + 22 + legOffset, this.y + 50, 8, 15);
        
        ctx.fillStyle = '#ff8c42';
        ctx.fillRect(this.x + 12, this.y + 63, 12, 4);
        ctx.fillRect(this.x + 20 + legOffset, this.y + 63, 12, 4);
        
        ctx.restore();
    }
};

/* ================= PART√çCULAS ================= */
let particles = [];

function createParticles(x, y, color) {
    if (particles.length >= MAX_PARTICLES) return;
    
    for (let i = 0; i < 8; i++) {
        particles.push({
            x: x,
            y: y,
            vx: (Math.random() - 0.5) * 4,
            vy: Math.random() * -3 - 2,
            life: 30,
            color: color
        });
    }
}

function updateParticles() {
    particles = particles.filter(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.2;
        p.life--;
        return p.life > 0;
    });
}

function drawParticles() {
    particles.forEach(p => {
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life / 30;
        ctx.fillRect(p.x, p.y, 4, 4);
        ctx.globalAlpha = 1;
    });
}

/* ================= PARALLAX ================= */
let groundY = 0;
let clouds = [];
let mountains = [];

function initBackground() {
    for (let i = 0; i < 5; i++) {
        clouds.push({
            x: Math.random() * canvas.width,
            y: Math.random() * 100 + 20,
            size: 20 + Math.random() * 30,
            speed: 0.3
        });
    }
    
    for (let i = 0; i < 8; i++) {
        mountains.push({
            x: i * 200,
            height: 60 + Math.random() * 40,
            width: 150 + Math.random() * 100,
            speed: 0.5
        });
    }
    
    for (let i = 0; i < 80; i++) {
        stars.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height * 0.7,
            size: Math.random() * 2 + 1,
            twinkle: Math.random() * Math.PI * 2
        });
    }
}

function lerpColor(color1, color2, t) {
    const c1 = hexToRgb(color1);
    const c2 = hexToRgb(color2);
    
    const r = Math.round(c1.r + (c2.r - c1.r) * t);
    const g = Math.round(c1.g + (c2.g - c1.g) * t);
    const b = Math.round(c1.b + (c2.b - c1.b) * t);
    
    return rgbToHex(r, g, b);
}

function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : { r: 0, g: 0, b: 0 };
}

function rgbToHex(r, g, b) {
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}

function updateBackground() {
    const newTheme = getCurrentTheme(score);
    
    const lerpSpeed = 0.02;
    currentTheme.skyTop = lerpColor(currentTheme.skyTop, newTheme.skyTop, lerpSpeed);
    currentTheme.skyBottom = lerpColor(currentTheme.skyBottom, newTheme.skyBottom, lerpSpeed);
    currentTheme.groundColor = lerpColor(currentTheme.groundColor, newTheme.groundColor, lerpSpeed);
    currentTheme.cloudOpacity += (newTheme.cloudOpacity - currentTheme.cloudOpacity) * lerpSpeed;
    currentTheme.stars = newTheme.stars;
    currentTheme.moon = newTheme.moon;
    currentTheme.mountainColor = newTheme.mountainColor;
    
    document.body.style.background = currentTheme.skyTop;
    
    clouds.forEach(c => {
        c.x -= gameSpeed * c.speed;
        if (c.x + c.size < 0) {
            c.x = canvas.width;
            c.y = Math.random() * 100 + 20;
        }
    });
    
    mountains.forEach(m => {
        m.x -= gameSpeed * m.speed;
        if (m.x + m.width < 0) {
            m.x = canvas.width;
            m.height = 60 + Math.random() * 40;
        }
    });
    
    if (currentTheme.stars) {
        stars.forEach(s => {
            s.twinkle += 0.05;
            s.x -= gameSpeed * 0.1;
            if (s.x < 0) s.x = canvas.width;
        });
    }
}

function drawBackground() {
    const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    skyGradient.addColorStop(0, currentTheme.skyTop);
    skyGradient.addColorStop(0.65, currentTheme.skyBottom);
    skyGradient.addColorStop(1, currentTheme.groundColor);
    ctx.fillStyle = skyGradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    if (currentTheme.stars) {
        stars.forEach(s => {
            const opacity = (Math.sin(s.twinkle) + 1) / 2;
            ctx.fillStyle = `rgba(255, 255, 255, ${opacity * 0.8})`;
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
            ctx.fill();
        });
    }
    
    if (currentTheme.moon) {
        ctx.fillStyle = 'rgba(255, 255, 200, 0.9)';
        ctx.shadowBlur = 20;
        ctx.shadowColor = 'rgba(255, 255, 150, 0.5)';
        ctx.beginPath();
        ctx.arc(canvas.width - 80, 60, 30, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
    }
    
    ctx.fillStyle = currentTheme.mountainColor;
    mountains.forEach(m => {
        ctx.beginPath();
        ctx.moveTo(m.x, groundY);
        ctx.lineTo(m.x + m.width/2, groundY - m.height);
        ctx.lineTo(m.x + m.width, groundY);
        ctx.closePath();
        ctx.fill();
    });
    
    ctx.fillStyle = `rgba(255,255,255,${currentTheme.cloudOpacity})`;
    clouds.forEach(c => {
        ctx.beginPath();
        ctx.arc(c.x, c.y, c.size * 0.5, 0, Math.PI * 2);
        ctx.arc(c.x + c.size * 0.4, c.y, c.size * 0.6, 0, Math.PI * 2);
        ctx.arc(c.x + c.size * 0.8, c.y, c.size * 0.5, 0, Math.PI * 2);
        ctx.fill();
    });
}

/* ================= OBST√ÅCULOS ================= */
let obstacles = [];
let obstacleTimer = 0;

const obstacleTypes = [
    { w: 24, h: 35, color: '#8b4513', type: 'ground' },
    { w: 30, h: 45, color: '#654321', type: 'ground' },
    { w: 35, h: 28, color: '#a0522d', type: 'ground' },
    { w: 40, h: 25, color: '#8B4513', type: 'flying' }, // Pterod√°ctilo antigo
    { w: 30, h: 25, color: '#FF0000', type: 'bird' }   // NOVO: P√°ssaro Tri√¢ngulo Vermelho
];

function createObstacle() {
    const type = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
    
    let obsY = groundY - type.h;
    
    if (type.type === 'flying') {
        obsY = groundY - 100 - Math.random() * 50;
    } else if (type.type === 'bird') {
        obsY = groundY - 60 - Math.random() * 80; // Altura vari√°vel para o p√°ssaro
    }

    obstacles.push({
        x: canvas.width + 20,
        y: obsY,
        w: type.w,
        h: type.h,
        color: type.color,
        type: type.type,
        wingFrame: 0,
        scored: false
    });
}

function updateObstacles() {
    if (!gameStarted || gamePaused) return;
    
    obstacleTimer++;
    const spawnRate = Math.max(50, 90 - Math.floor(score / 100));
    
    if (obstacleTimer > spawnRate) {
        createObstacle();
        obstacleTimer = 0;
    }

    obstacles.forEach(o => {
        o.x -= gameSpeed;
        
        if (o.type === 'flying') {
            o.wingFrame += 0.3;
            o.y += Math.sin(o.wingFrame) * 1.5;
        } 
        else if (o.type === 'bird') {
            o.wingFrame += 0.5;
            o.y += Math.sin(o.wingFrame) * 2; // Movimento mais r√°pido vertical
        }
        
        if (!o.scored && o.x + o.w < dino.x) {
            o.scored = true;
            score += 10;
        }
    });
    
    obstacles = obstacles.filter(o => o.x + o.w > 0);
    
    // Aumenta a velocidade base progressivamente
    baseGameSpeed = 5 + Math.floor(score / 100) * 0.5;
}

function drawObstacles() {
    obstacles.forEach(o => {
        ctx.fillStyle = o.color;
        
        if (o.type === 'bird') {
            // Desenha P√°ssaro Tri√¢ngulo Vermelho
            ctx.save();
            ctx.translate(o.x + o.w/2, o.y + o.h/2);
            ctx.fillStyle = '#FF4444';
            ctx.beginPath();
            ctx.moveTo(-15, 0); // Ponta esquerda
            ctx.lineTo(15, -10); // Asa Cima
            ctx.lineTo(15, 10); // Asa Baixo
            ctx.closePath();
            ctx.fill();
            
            // Olho
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(-5, -2, 4, 0, Math.PI*2);
            ctx.fill();
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(-7, -2, 1.5, 0, Math.PI*2);
            ctx.fill();
            
            ctx.restore();

        } else if (o.type === 'flying') {
            ctx.save();
            ctx.translate(o.x + o.w/2, o.y + o.h/2);
            
            ctx.fillStyle = '#6d4c41';
            ctx.fillRect(-15, -8, 30, 16);
            
            ctx.beginPath();
            ctx.arc(12, 0, 10, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#ff9800';
            ctx.beginPath();
            ctx.moveTo(18, -3);
            ctx.lineTo(25, 0);
            ctx.lineTo(18, 3);
            ctx.fill();
            
            const wingAngle = Math.sin(o.wingFrame) * 0.5;
            ctx.fillStyle = '#8d6e63';
            ctx.save();
            ctx.rotate(wingAngle);
            ctx.fillRect(-10, -20, 20, 15);
            ctx.restore();
            ctx.save();
            ctx.rotate(-wingAngle);
            ctx.fillRect(-10, 5, 20, 15);
            ctx.restore();
            
            ctx.restore();
        } else {
            if (o.h > 40) {
                ctx.fillRect(o.x + 8, o.y, 14, o.h);
                ctx.fillRect(o.x, o.y + 10, 8, 15);
                ctx.fillRect(o.x + 22, o.y + 15, 8, 12);
                ctx.fillStyle = '#4a7c4e';
                ctx.fillRect(o.x + 10, o.y, 3, 8);
                ctx.fillRect(o.x + 17, o.y + 5, 3, 8);
            } else if (o.h > 30) {
                ctx.fillRect(o.x + 6, o.y, 12, o.h);
                ctx.fillRect(o.x, o.y + 8, 6, 12);
                ctx.fillStyle = '#4a7c4e';
                ctx.fillRect(o.x + 9, o.y, 2, 6);
            } else {
                ctx.beginPath();
                ctx.ellipse(o.x + o.w/2, o.y + o.h/2, o.w/2, o.h/2, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#8b7355';
                ctx.beginPath();
                ctx.ellipse(o.x + o.w/2, o.y + o.h/3, o.w/3, o.h/4, 0, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    });
}

/* ================= SCORE ================= */
let score = 0;
let bestScore = Number(localStorage.getItem("dinopepe_recorde")) || 0;

function drawScore() {
    document.getElementById("scoreText").innerHTML =
        `Pontos: <strong>${Math.floor(score)}</strong> | ü™ô <strong>${totalCoins}</strong> | Recorde: <strong>${bestScore}</strong>`;
}

/* ================= COLIS√ÉO ================= */
function checkCollision() {
    // Se tiver Escudo ou Dash, n√£o morre
    if (activePowerups.shield > 0 || activePowerups.dash > 0) return false;
    
    for (let o of obstacles) {
        // Reduz a hitbox ligeiramente para ser justo
        if (
            dino.x + 12 < o.x + o.w &&
            dino.x + dino.w - 12 > o.x &&
            dino.y + dino.h - 8 > o.y &&
            dino.y + 12 < o.y + o.h
        ) {
            return true;
        }
    }
    return false;
}

/* ================= GAME ================= */
let gameOver = false;

function endGame() {
    gameOver = true;
    hitSound();
    
    createParticles(dino.x + dino.w/2, dino.y + dino.h/2, '#ff4444');

    const finalScoreNum = Math.floor(score);
    if (finalScoreNum > bestScore) {
        bestScore = finalScoreNum;
        saveGameData(); // Salva tudo ao fim do jogo
    }

    document.getElementById("finalScore").innerHTML = 
        `Pontos: <strong>${finalScoreNum}</strong><br>` +
        `Moedas: <strong>ü™ô ${totalCoins}</strong><br>` +
        `Recorde: <strong>${bestScore}</strong>`;
    document.getElementById("gameOverScreen").style.display = "flex";
    document.getElementById("pauseBtn").style.display = "none";
    document.getElementById("shopBtn").style.display = "none";
}

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    groundY = canvas.height - 30;

    if (clouds.length === 0) initBackground();
    updateBackground();
    drawBackground();

    const groundDark = lerpColor(currentTheme.groundColor, '#000000', 0.3);
    ctx.strokeStyle = groundDark;
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(0, groundY);
    ctx.lineTo(canvas.width, groundY);
    ctx.stroke();
    
    ctx.fillStyle = currentTheme.groundColor;
    for (let i = 0; i < canvas.width; i += 15) {
        ctx.fillRect(i, groundY + 2, 2, 6);
        ctx.fillRect(i + 5, groundY + 1, 2, 8);
        ctx.fillRect(i + 10, groundY + 3, 2, 5);
    }

    if (!gameOver && gameStarted) {
        dino.update();
        
        if (!gamePaused) {
            updateObstacles();
            updateCoins();
            updatePowerups();
            score += 0.1;

            if (checkCollision()) endGame();
        }
    }

    updateParticles();
    drawParticles();
    drawObstacles();
    drawCoins();
    drawPowerups();
    updateDrawFloatingTexts(); // Desenha os textos flutuantes
    dino.draw();
    drawScore();
    drawPowerupBar();

    animFrame++;
    requestAnimationFrame(loop);
}

/* ================= CONTROLES ================= */
document.addEventListener("keydown", e => {
    if (e.code === "Space") {
        e.preventDefault();
        dino.jump();
    }
});

canvas.addEventListener("click", () => dino.jump());
canvas.addEventListener("touchstart", (e) => {
    e.preventDefault();
    dino.jump();
});

let lastOrientation = { beta: 0, gamma: 0 };
let lastJump = 0;
let orientationSupported = false;
let lastAcceleration = { x: 0, y: 0, z: 0 };

if (window.DeviceOrientationEvent) {
    window.addEventListener("deviceorientation", e => {
        if (!gameStarted || gameOver || gamePaused) return;
        
        orientationSupported = true;
        const now = Date.now();
        
        const beta = e.beta || 0;
        const gamma = e.gamma || 0;
        
        const betaDelta = lastOrientation.beta - beta;
        
        const isShake = betaDelta > 15 && now - lastJump > 400;
        
        if (isShake) {
            dino.jump();
            lastJump = now;
        }
        
        lastOrientation = { beta, gamma };
    });
}

window.addEventListener("devicemotion", e => {
    if (orientationSupported || !gameStarted || gameOver || gamePaused) return;
    if (!e.accelerationIncludingGravity) return;
    
    const acc = e.accelerationIncludingGravity;
    const now = Date.now();
    
    const isLandscape = window.innerWidth > window.innerHeight;
    
    let shakeForce = 0;
    
    if (isLandscape) {
        shakeForce = Math.abs(acc.x - lastAcceleration.x);
    } else {
        const deltaY = Math.abs(acc.y - lastAcceleration.y);
        const deltaZ = Math.abs(acc.z - lastAcceleration.z);
        shakeForce = Math.max(deltaY, deltaZ);
    }
    
    const isShake = shakeForce > 10 && now - lastJump > 400;
    
    if (isShake) {
        dino.jump();
        lastJump = now;
    }
    
    lastAcceleration = { x: acc.x, y: acc.y, z: acc.z };
});

/* ================= FOTO ================= */
const photoPreview = document.getElementById("photoPreview");
const previewImg = document.getElementById("previewImg");
const fileInput = document.getElementById("faceUpload");

fileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    gamePaused = true;

    const reader = new FileReader();
    reader.onload = ev => {
        const img = new Image();
        img.onload = () => {
            faceImage = img;
            previewImg.src = ev.target.result;
            photoPreview.style.display = "flex";
            fileInput.style.display = "none";
            
            setTimeout(() => {
                gamePaused = false;
            }, 500);
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
});

document.getElementById("removePhoto").onclick = () => {
    faceImage = null;
    photoPreview.style.display = "none";
    fileInput.style.display = "inline-block";
    fileInput.value = "";
};

/* ================= INICIO/RESTART ================= */
document.getElementById("startBtn").onclick = () => {
    document.getElementById("tutorialScreen").style.display = "none";
    gameStarted = true;
    document.getElementById("shopBtn").style.display = "block";
    
    if (typeof DeviceOrientationEvent !== 'undefined' && 
        typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(response => {
                if (response === 'granted') {
                    orientationSupported = true;
                }
            })
            .catch(console.error);
    }
};

function resetGame() {
    gameOver = false;
    gameStarted = false;
    gamePaused = false;
    score = 0;
    // N√£o resetamos totalCoins, pois queremos acumular
    gameSpeed = 5;
    baseGameSpeed = 5;
    obstacles = [];
    obstacleTimer = 0;
    particles = [];
    coins = [];
    coinTimer = 0;
    powerups = [];
    powerupTimer = 0;
    activePowerups = { shield: 0, magnet: 0, slowmo: 0, dash: 0 };
    floatingTexts = [];
    
    currentTheme = getCurrentTheme(0);
    
    dino.y = 0;
    dino.vy = 0;
    dino.jumping = false;
    dino.doubleJumped = false;
    dino.legFrame = 0;
    
    document.getElementById("gameOverScreen").style.display = "none";
    document.getElementById("pauseBtn").style.display = "none";
    document.getElementById("shopBtn").style.display = "none"; // S√≥ aparece quando come√ßar
    
    setTimeout(() => {
        gameStarted = true;
        document.getElementById("shopBtn").style.display = "block";
    }, 500);
}

document.getElementById("restartBtn").onclick = resetGame;

const pauseBtn = document.getElementById("pauseBtn");

pauseBtn.onclick = () => {
    if (!gameStarted || gameOver) return;
    
    gamePaused = !gamePaused;
    pauseBtn.textContent = gamePaused ? "‚ñ∂Ô∏è" : "‚è∏Ô∏è";
};

setInterval(() => {
    if (gameStarted && !gameOver && pauseBtn.style.display === "none") {
        pauseBtn.style.display = "block";
        pauseBtn.textContent = "‚è∏Ô∏è";
    }
}, 1000);

loop();
</script>
</body>
</html>
